#
#    See the NOTICE file distributed with this work for additional information
#    regarding copyright ownership.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.
#

name: daily run for taf

on:
  schedule:
    - cron: 0 5 * * *
  workflow_dispatch:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        #os: [ubuntu-latest, windows-latest]
        node-version: [16.x]
      # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
        
    runs-on: ${{ matrix.os }}
    env:
      USER_ID: 1001
      GROUP_ID: 1001
      
      OAUTH_CLIENT_ID: APP-ZX6M8LSAN3YIIAQ5
      OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_DOMAIN: localhost
      
      DB_PASSWORD: postgres
      DB_SERVER: dbserver:5432
      DB_NAME: bidb
      DB_USER: postgres
      ADMIN_ORCID: 0000-0003-0437-8310
      
      API_INTERNAL_PORT: 8081
      API_INTERNAL_TEST_PORT: 8082

      BRAPI_SERVER_PORT: 8080

      BRAPI_DEFAULT_URL: http://brapiserver:8080
      BRAPI_REFERENCE_SOURCE: breeding-insight.net
      BRAPI_DB_SERVER: dbserver:5432
      BRAPI_DB: postgres
      BRAPI_DB_USER: postgres
      BRAPI_DB_PASSWORD: postgres
      WEB_BASE_URL: http://localhost
      API_BASE_URL: http://localhost
      REGISTERED_DOMAIN: localhost
      EMAIL_RELAY_HOST: mailhog
      EMAIL_RELAY_PORT: 1025
      EMAIL_FROM: bidevteam@cornell.edu
    
    #services:
    #  selenium:
    #    image: selenium/standalone-chrome

    steps:
    - uses: actions/checkout@v2
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
    
    #check out docker stuff
    - name: Docker checkout (private)
      uses: actions/checkout@v2
      with:
       repository: Breeding-Insight/bi-docker-stack
       token: ${{ secrets.DOCKERPATH }}
       path: bi-docker-stack
    
    - run: npm install
    
    - name: set up debug for github actions
      run: npm install --save-prod @actions/github @actions/core
    
    - name: Set up JDK 13
      uses: actions/setup-java@v1.4.3
      with:
          java-version: 13
          
      #from bi-docker-stack
    - run: docker-compose -f bi-docker-stack/docker-compose.yml -f bi-docker-stack/docker-compose-qa.yml up -d
          
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@latest
      #run: |
      #  sudo apt-get update
      #  sudo apt-get --only-upgrade install google-chrome-stable
      #  google-chrome --version
      #uses: browser-actions/setup-chrome@90.0.4430
      #run: |
      #    VERSION_STRING="88.0.4324.96-1"
      #    wget "https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_90.0.4430_amd64.deb"
      #    sudo dpkg -i "google-chrome-stable_90.0.4430_amd64.deb"
      if: matrix.os == 'ubuntu-latest'
      
    #- name: Get chrome stable
    #  uses: ./dist/
    #  with:
    #   chrome-version: stable
      
    - name: Run Chrome
      if: matrix.os == 'ubuntu-latest'
      run: chrome --version
      
    #- name: Set up compatible chromedriver
    #  uses: nanasess/setup-chromedriver@master
      #with:
      #  chromedriver-version: '91.0.4472'
        
    #- name: Run compatible chromedriver
      #run: |
        #export DISPLAY=:99
        #chromedriver --url-base=/wd/hub &
        #sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 & # optional
      
    - name: Set up Edge
      uses: browser-actions/setup-edge@latest
      if: matrix.os == 'windows-latest'
    
    - name: Sleep to ensure docker set up
      run: sleep 30s
      shell: bash
      
    #- uses: actions/checkout@v2
    - name: set up required data for tests
      #shell: bash #'script -q -e -c "bash {0}"'    
      run: | 
        #echo $(ls)
        #docker exec bidb ADD /taf/populate-taf-data.sql root/
        #/home/host
        #docker exec pwd
        #docker exec cp populate-taf-data.sql bidb:/populate-taf-data.sql
        docker cp populate-taf-data.sql bidb:/populate-taf-data.sql
        docker exec bidb psql -U postgres -a -f populate-taf-data.sql -d bidb -v filePath="${{ github.workspace }}/programIds.json"  #eventually remove a cause output messy
    
    - name: set up brapi data
      run: |
        trailMixId=$( docker exec bidb psql -U postgres -d bidb -t -c "SELECT id FROM program WHERE name='Trail Mix'" )
        snacksId=$( docker exec bidb psql -U postgres -d bidb -t -c "SELECT id FROM program WHERE name='Snacks'" )
        #netstat -a
        sudo netstat -plnt
        #docker exec brapiserver node brapi-taf-setup.mjs "$snacksId" "$trailMixId"
        curl --header "Content-Type: application/json" -d "{\"programName\":\"Snacks\",\"externalReferences\":{\"referenceSource\":\"breeding-insight.org\",\"referenceID\":\"$snacksId\"}}" http://localhost:8080/brapi/v2/programs
        
    - name: Run tests on Chrome
      if: matrix.os == 'ubuntu-latest'
    #- run: npm ci #unclear if needed
    #- run: npm run build --if-present #unclear if needed
      #run: npm run test:chrome
      #run: |
      #  $Env:CHROMIUM_BIN = "chrome"
      #  npm run test:chrome --headless --no-sandbox
      run: npm run test:chromeDaily --headless --no-sandbox
      
    - name: Run tests on Edge
      if: matrix.os == 'windows-latest'
      run: npm run test:edge
    
    #- name: Create Report Folder
    #  if: always()
    #  run: |	
    #    mkdir -p ${{ github.workspace }}/artifact/reports
    #    cd ${{ github.workspace }}/artifact/reports
    #    echo 'cucumber_report.html' > ${{ github.workspace }}/artifact/reports/cucumber_report.html
      
    - name: Publish Report Artifact
      uses: actions/upload-artifact@v2
      if: always()
      with:
        name: cucumber-report-${{ matrix.os }}-${{ github.run_number }} #TODO modify matrix to have file name be chrome/edge
        path: ${{ github.workspace }}/report/*
        #path: ${{ github.workspace }}/artifact/reports
    
    
    
    
